---
import { readdir } from "fs/promises";
import { resolve } from "path";
import { readFileSync } from "fs";
import { Recipe } from "@tmlmt/cooklang-parser";
import JsonLdSchema from "../../components/JsonLdSchema.astro";
import IngredientList from "../../components/IngredientList.astro";
import RecipeSteps from "../../components/RecipeSteps.astro";
import CookwareList from "../../components/CookwareList.astro";
import CooklangSourceBlock from "../../components/CooklangSourceBlock.astro";
import ThemeToggle from "../../components/ThemeToggle.astro";
import Layout from "../../layouts/Layout.astro";
import { parseFrontmatter, generateJsonLdSchema } from "../../utils/recipe-metadata";

export async function getStaticPaths() {
  const recipesDir = resolve("recipes");
  const files = await readdir(recipesDir);
  const cookFiles = files.filter((f) => f.endsWith(".cook"));

  return cookFiles.map((file) => ({
    params: { slug: file.replace(".cook", "") },
  }));
}

const { slug } = Astro.params;
const recipePath = resolve("recipes", `${slug}.cook`);
const content = readFileSync(recipePath, "utf-8");

// Extract YAML frontmatter
const { frontmatter, recipeContent } = parseFrontmatter(content);

let recipe;
let parseError = null;

try {
  recipe = new Recipe(recipeContent);
} catch (error) {
  console.error(`Error parsing recipe ${slug}:`, error.message);
  parseError = error.message;
  recipe = {
    metadata: {},
    ingredients: [],
    sections: [],
    cookware: [],
    timers: [],
  };
}

// Merge frontmatter with parsed metadata - frontmatter takes priority
recipe.metadata = { ...recipe.metadata, ...frontmatter };

const ingredients = recipe.ingredients || [];
const cookwareList = recipe.cookware || [];
const timersList = recipe.timers || [];

// Extract steps from sections
const steps = [];
if (recipe.sections) {
  for (const section of recipe.sections) {
    if (section.content) {
      const sectionSteps = section.content.filter((item: any) => item.type === "step");
      steps.push(...sectionSteps);
    }
  }
}

const imageUrl = recipe.metadata.image?.replace(/^["']|["']$/g, "") || null;
const tags = recipe.metadata.tags || [];
const source = recipe.metadata.source;

// Generate JSON-LD schema
const jsonLd = generateJsonLdSchema(
  recipe.metadata,
  imageUrl,
  tags,
  source,
  ingredients,
  steps,
  cookwareList,
  timersList
);
---

<Layout title={recipe.metadata.title || slug} description={recipe.metadata.description} image={imageUrl}>
  <Fragment slot="theme-toggle">
    <ThemeToggle />
  </Fragment>

  <Fragment slot="head">
    <JsonLdSchema schema={jsonLd} />
  </Fragment>

  <div class="recipe-header">
    <a href={import.meta.env.BASE_URL} class="back-button">‚Üê Back to recipes</a>
    <h1>{recipe.metadata.title || slug}</h1>
    {recipe.metadata.description && <p>{recipe.metadata.description}</p>}

    {tags.length > 0 && (
      <div class="tags">
        {tags.map((tag: string) => (
          <a href={`${import.meta.env.BASE_URL}tags/${tag}/`} class="tag">
            #{tag}
          </a>
        ))}
      </div>
    )}

    {source && (
      <div class="source">
        <div class="source-label">Source:</div>
        <a href={source} target="_blank" rel="noopener noreferrer">{source}</a>
      </div>
    )}

    <div class="recipe-controls" data-recipe-controls>
      <button type="button" class="button secondary" id="recipePrintBtn">üñ®Ô∏è Print</button>
      <button type="button" class="button primary" id="addToShoppingListBtn"
              data-recipe-slug={slug}
              data-recipe-title={recipe.metadata.title || slug}>
        üõí Add to Shopping List
      </button>

      <label class="scale">
        <span class="scale-label">Scale</span>
        <input
          id="recipeScaleInput"
          type="number"
          inputmode="decimal"
          step="0.1"
          min="0.1"
          value="1"
        />
        <span class="scale-suffix">√ó</span>
      </label>
    </div>
  </div>

  <div class="hero-section">
    <div class="recipe-image-container">
      {imageUrl ? (
        <img
          src={imageUrl}
          alt={recipe.metadata.title || slug}
          class="recipe-image"
          onerror="this.style.display='none';this.nextElementSibling.style.display='flex';"
          loading="lazy"
        />
      ) : null}
      <div class="image-fallback" style={imageUrl ? "display: none;" : "display: flex;"}>
        <span class="fallback-icon">üç≥</span>
        <span class="fallback-text">No Image</span>
      </div>
    </div>

    <div class="recipe-meta">
      {recipe.metadata?.servings && (
        <div class="meta-item">
          <div class="meta-label">Servings</div>
          <div class="meta-value">{recipe.metadata.servings}</div>
        </div>
      )}

      {recipe.metadata?.["prep-time"] && (
        <div class="meta-item">
          <div class="meta-label">Prep Time</div>
          <div class="meta-value">{recipe.metadata["prep-time"]}</div>
        </div>
      )}

      {recipe.metadata?.["cook-time"] && (
        <div class="meta-item">
          <div class="meta-label">Cook Time</div>
          <div class="meta-value">{recipe.metadata["cook-time"]}</div>
        </div>
      )}

      {recipe.metadata?.["total-time"] && (
        <div class="meta-item">
          <div class="meta-label">Total Time</div>
          <div class="meta-value">{recipe.metadata["total-time"]}</div>
        </div>
      )}
    </div>
  </div>

  <div class="recipe-content">
    <div class="recipe-column">
      <div class="recipe-section">
        <h2>ü•ò Ingredients</h2>
        <IngredientList ingredients={ingredients} />
      </div>

      {cookwareList.length > 0 && (
        <div class="recipe-section">
          <h2>üç≥ Cookware</h2>
          <CookwareList cookware={cookwareList} />
        </div>
      )}
    </div>

    <div class="recipe-column">
      <div class="recipe-section">
        <h2>üë®‚Äçüç≥ Instructions</h2>
        {steps.length > 0 ? (
          <RecipeSteps steps={steps} cookware={cookwareList} timers={timersList} />
        ) : (
          <p>No instructions found</p>
        )}
      </div>
    </div>
  </div>

  <CooklangSourceBlock slug={slug} text={content} />

  <Fragment slot="scripts">
    <script type="module">
      import { formatQty } from '/scripts/quantity-formatter.js';
      import { applyScale } from '/scripts/recipe-scaler.js';

      const controls = document.querySelector("[data-recipe-controls]");
      if (controls) {
        const printBtn = document.getElementById("recipePrintBtn");
        const scaleInput = document.getElementById("recipeScaleInput");

        if (printBtn) printBtn.addEventListener("click", () => window.print());

        if (scaleInput) {
          scaleInput.addEventListener("input", () => {
            const mult = Number(scaleInput.value || "1");
            applyScale(Number.isFinite(mult) && mult > 0 ? mult : 1);
          });

          applyScale(Number(scaleInput.value || "1") || 1);
        }

        // Shopping list functionality
        const addToShoppingListBtn = document.getElementById("addToShoppingListBtn");
        if (addToShoppingListBtn) {
          import('/scripts/recipe-shopping-list.js').then(module => {
            const recipeSlug = addToShoppingListBtn.getAttribute('data-recipe-slug');
            const recipeTitle = addToShoppingListBtn.getAttribute('data-recipe-title');

            module.initializeShoppingListButton(addToShoppingListBtn, recipeSlug);
            module.setupShoppingListButton(addToShoppingListBtn, recipeSlug, recipeTitle);
          });
        }
      }
    </script>
  </Fragment>
</Layout>

<style>
  .recipe-header {
    margin-bottom: 1rem;
  }

  /* Recipe controls */
  .recipe-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
    margin: 1rem 0 0.5rem;
  }

  .recipe-controls .scale {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--surface);
    border: 2px solid var(--border);
    padding: 0.4rem 0.6rem;
    border-radius: 8px;
  }

  .recipe-controls .scale-label {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .recipe-controls #recipeScaleInput {
    width: 5.5rem;
    border: 0;
    outline: none;
    font-size: 1rem;
    background: transparent;
    color: var(--input-text);
  }

  .recipe-controls .scale-suffix {
    color: var(--muted);
    font-weight: 700;
  }

  /* Image + meta */
  .hero-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin: 1.5rem 0;
  }

  @media (max-width: 768px) {
    .hero-section {
      grid-template-columns: 1fr;
    }
  }

  .recipe-image-container {
    display: flex;
    align-items: flex-start;
  }

  .recipe-image {
    max-width: 100%;
    width: 100%;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
  }

  /* Image fallback styling */
  .image-fallback {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    min-height: 300px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    gap: 0.5rem;
  }

  .fallback-icon {
    font-size: 3rem;
    opacity: 0.6;
  }

  .fallback-text {
    font-size: 1rem;
    color: var(--muted);
    font-family: system-ui, sans-serif;
  }

  .recipe-meta {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    align-content: start;
  }

  .meta-item {
    background: var(--surface);
    padding: 1rem;
    border-radius: 6px;
    border-left: 3px solid var(--accent);
  }

  .meta-label {
    font-size: 0.85rem;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }

  .meta-value {
    font-weight: bold;
    color: var(--text);
    font-size: 1.25rem;
  }

  .recipe-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin: 2rem 0;
  }

  .recipe-column {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  @media (max-width: 968px) {
    .recipe-content {
      grid-template-columns: 1fr;
    }
  }

  .recipe-section {
    background: var(--surface);
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .recipe-section h2 {
    color: var(--text);
    border-bottom: 2px solid var(--accent);
    padding-bottom: 0.5rem;
    margin-top: 0;
    margin-bottom: 1rem;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
  }

  .tag {
    background: var(--surface);
    color: var(--accent-2);
    padding: 0.25rem 0.75rem;
    border-radius: 16px;
    font-size: 0.85rem;
    text-decoration: none;
    border: 1px solid var(--accent-2);
    transition: all 0.2s ease;
  }

  .tag:hover {
    background: var(--accent-2);
    color: white;
    transform: translateY(-1px);
  }

  /* Dark mode tag adjustments */
  html[data-theme="dark"] .tag {
    color: #5db2ff;
    border-color: #5db2ff;
  }

  html[data-theme="dark"] .tag:hover {
    background: #5db2ff;
    color: var(--surface);
  }

  .source {
    background: var(--surface);
    border-left: 3px solid var(--accent);
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 4px;
  }

  .source-label {
    font-size: 0.85rem;
    color: var(--accent);
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .source a {
    color: var(--accent-2);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .source a:hover {
    text-decoration: underline;
    color: var(--accent-2);
    filter: brightness(1.2);
  }

  /* Dark mode source link adjustments */
  html[data-theme="dark"] .source a {
    color: #5db2ff;
  }

  html[data-theme="dark"] .source a:hover {
    color: #7dc3ff;
  }

  /* Back button styling */
  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--accent-2);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: bold;
    border: 0;
    cursor: pointer;
    transition: background 0.2s;
    margin-bottom: 1rem;
  }

  .back-button:hover {
    background: #0770c9;
    text-decoration: none;
  }

  html[data-theme="dark"] .back-button {
    background: #5db2ff;
  }

  html[data-theme="dark"] .back-button:hover {
    background: #7dc3ff;
  }

  /* Recipe image responsive styling */
  .recipe-image-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
  }

  @media print {
    .recipe-header .back-button,
    .recipe-controls,
    .tags,
    .source {
      display: none !important;
    }

    body {
      background: white;
      color: black;
      padding: 0;
      max-width: none;
    }

    .recipe-section {
      box-shadow: none;
      border: 1px solid #ccc;
    }
  }

  /* Notification animations */
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
</style>
